<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --accent-color: #bb86fc;
            --accent-hover: #9965f4;
            --danger-color: #cf6679;
            --danger-hover: #b44d60;
            --success-color: #03dac6;
            --success-hover: #01bdae;
            --border-radius: 12px;
            --spacing: 16px;
            --transition-speed: 0.3s;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        h1,
        h2,
        h3 {
            color: var(--text-primary);
            font-weight: 600;
            margin-top: 0;
        }

        h1 {
            text-align: center;
            margin-bottom: 40px;
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--accent-color), #3700b3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -1px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }

        @media (min-width: 900px) {
            .container {
                grid-template-columns: 1fr 1.2fr;
            }
        }

        .section {
            background-color: var(--card-bg);
            padding: 24px;
            border-radius: var(--border-radius);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
        }

        .video-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 600px;
            overflow-y: auto;
        }

        /* Scrollbar styling */
        .video-list::-webkit-scrollbar {
            width: 8px;
        }

        .video-list::-webkit-scrollbar-track {
            background: #2c2c2c;
        }

        .video-list::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }

        .video-list::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        .video-item {
            background-color: #2c2c2c;
            margin-bottom: 12px;
            padding: 16px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all var(--transition-speed) ease;
            border: 1px solid transparent;
        }

        .video-item:hover:not(.dropdown-open) {
            transform: translateY(-2px);
            background-color: #333;
            border-color: rgba(187, 134, 252, 0.3);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .video-item.dropdown-open {
            transform: none !important;
        }

        .video-info {
            flex: 1;
            margin-right: 15px;
        }

        .video-title {
            font-weight: 500;
            font-size: 1rem;
            display: block;
            margin-bottom: 4px;
        }

        .video-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin: 4px 0 8px 0;
            line-height: 1.4;
            opacity: 0.8;
        }

        .video-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-aprobado {
            background-color: rgba(3, 218, 198, 0.2);
            color: var(--success-color);
        }

        .status-rechazado {
            background-color: rgba(207, 102, 121, 0.2);
            color: var(--danger-color);
        }

        .status-pendiente {
            background-color: rgba(255, 255, 255, 0.1);
            color: #aaa;
        }

        button {
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-family: inherit;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        button:active {
            transform: scale(0.95);
        }

        .btn-icon {
            padding: 0;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            font-size: 1rem;
            line-height: 1;
        }

        .btn-delete {
            background-color: rgba(207, 102, 121, 0.15);
            color: var(--danger-color);
        }

        .btn-delete:hover {
            background-color: var(--danger-color);
            color: #000;
        }

        .btn-approve {
            background-color: rgba(3, 218, 198, 0.15);
            color: var(--success-color);
        }

        .btn-approve:hover {
            background-color: var(--success-color);
            color: #000;
        }

        .btn-reject {
            background-color: rgba(207, 102, 121, 0.15);
            color: var(--danger-color);
        }

        .btn-reject:hover {
            background-color: var(--danger-color);
            color: #000;
        }

        .btn-download {
            background-color: var(--accent-color);
            color: #000;
        }

        .btn-download:hover {
            background-color: var(--accent-hover);
        }

        .btn-play {
            background-color: var(--accent-color);
            color: #000;
            padding: 0 16px;
            height: 36px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-play:hover {
            background-color: var(--accent-hover);
        }

        /* Dropdown Menu */
        .dropdown-container {
            position: relative;
            display: inline-block;
        }

        .btn-more {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .btn-more:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .dropdown-menu {
            display: none;
            position: fixed; /* Evita clipping dentro de contenedores con overflow */
            background-color: #333;
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            z-index: 3000; /* Por encima de todo */
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .dropdown-menu.show {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        .dropdown-item {
            padding: 10px 16px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
            text-align: left;
            border: none;
            width: 100%;
            background: none;
        }

        .dropdown-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .player-container {
            margin-top: 0;
            margin-bottom: 20px;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 16/9;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .player-container iframe,
        .player-container video {
            width: 100%;
            height: 100%;
            border: none;
        }

        .empty-state {
            text-align: center;
            color: var(--text-secondary);
            padding: 40px 20px;
            font-style: italic;
        }

        .actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* Loader */
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loader {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #333;
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transform: translateY(100px);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.show {
            transform: translateY(0);
        }

        .toast.success {
            border-left: 4px solid var(--success-color);
        }

        .toast.error {
            border-left: 4px solid var(--danger-color);
        }
    </style>
</head>

<body>
    <div id="loader" class="loader-container">
        <div class="loader"></div>
    </div>

    <div id="toast" class="toast"></div>

    <h1>Reels Virales Manager</h1>

    <div id="app" class="container" style="display: none;">
        <!-- Pending Videos Section -->
        <div class="section">
            <div class="section-header">
                <h2>Pendientes de Creaci√≥n</h2>
                <span id="pending-count" style="color: var(--text-secondary)">0</span>
            </div>
            <div id="pending-list" class="video-list"></div>
        </div>

        <!-- Created Videos Section -->
        <div class="section">
            <div class="section-header">
                <h2>Revisi√≥n de Videos</h2>
                <span id="created-count" style="color: var(--text-secondary)">0</span>
            </div>

            <div id="player-wrapper" class="player-container">
                <div class="empty-state">
                    <div style="font-size: 3rem; margin-bottom: 10px;">‚ñ∂Ô∏è</div>
                    Selecciona un video para visualizar
                </div>
            </div>

            <h3>Lista de Videos Creados</h3>
            <div id="created-list" class="video-list"></div>
        </div>
    </div>

    <script>
        let allVideos = [];

        // Close dropdowns when clicking outside
        window.onclick = function (event) {
            if (!event.target.matches('.btn-more')) {
                const dropdowns = document.getElementsByClassName("dropdown-menu");
                for (let i = 0; i < dropdowns.length; i++) {
                    const openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
                const openItems = document.getElementsByClassName('video-item dropdown-open');
                while (openItems.length) {
                    openItems[0].classList.remove('dropdown-open');
                }
            }
        }

        function loadVideos() {
            document.getElementById('loader').style.display = 'flex';

            google.script.run
                .withSuccessHandler(renderVideos)
                .withFailureHandler(handleError)
                .getVideos();
        }

        function renderVideos(videos) {
            allVideos = videos;
            const pendingList = document.getElementById('pending-list');
            const createdList = document.getElementById('created-list');

            pendingList.innerHTML = '';
            createdList.innerHTML = '';

            const pendingVideos = videos.filter(v => v.statusCreacion === 'Pendiente');
            // Filtrar videos creados que adem√°s tengan status de publicaci√≥n pendiente
            const createdVideos = videos.filter(v => v.statusCreacion === 'Creado' && v.statusPublicacion === 'Pendiente');

            document.getElementById('pending-count').textContent = pendingVideos.length;
            document.getElementById('created-count').textContent = createdVideos.length;

            // Render Pending
            if (pendingVideos.length === 0) {
                pendingList.innerHTML = '<div class="empty-state">No hay videos pendientes</div>';
            } else {
                pendingVideos.forEach(video => {
                    const item = document.createElement('div');
                    item.className = 'video-item';
                    item.innerHTML = `
                    <div class="video-info">
                        <span class="video-title">${video.idea}</span>
                        <p class="video-description">${video.descripcion || ''}</p>
                        <span class="video-meta">Fila: ${video.rowIndex}</span>
                    </div>
                    <button class="btn-delete" onclick="deleteVideo(${video.rowIndex})" title="Eliminar">
                        üóëÔ∏è
                    </button>
                `;
                    pendingList.appendChild(item);
                });
            }

            // Render Created
            if (createdVideos.length === 0) {
                createdList.innerHTML = '<div class="empty-state">No hay videos para revisar</div>';
            } else {
                createdVideos.forEach(video => {
                    const item = document.createElement('div');
                    item.className = 'video-item';

                    let statusClass = 'status-pendiente';
                    let statusText = video.statusAprobacion || 'Sin Revisar';

                    if (video.statusAprobacion === 'Aprobado') statusClass = 'status-aprobado';
                    if (video.statusAprobacion === 'Rechazado') statusClass = 'status-rechazado';

                    item.innerHTML = `
                    <div class="video-info">
                        <span class="video-title">${video.idea}</span>
                        <p class="video-description">${video.descripcion || ''}</p>
                        <div class="video-meta">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                    <div class="actions">
                        <button class="btn-icon btn-approve" onclick="updateStatus(${video.rowIndex}, 'Aprobado')" title="Aprobar">‚úì</button>
                        <button class="btn-icon btn-reject" onclick="updateStatus(${video.rowIndex}, 'Rechazado')" title="Rechazar">‚úï</button>
                        <a href="${video.url}" target="_blank" class="btn-icon btn-download" style="text-decoration:none;" title="Descargar" download>üì•</a>
                        <button class="btn-play" onclick="playVideo('${video.url}')" title="Ver Video">‚ñ∂ Ver Video</button>

                        <!-- Men√∫ contextual al final de las opciones -->
                        <div class="dropdown-container">
                            <button class="btn-icon btn-more" onclick="toggleDropdown(event, ${video.rowIndex})" title="M√°s opciones">‚ãÆ</button>
                            <div id="dropdown-${video.rowIndex}" class="dropdown-menu">
                                <button class="dropdown-item" onclick="copyContent(${video.rowIndex}, 'title')">üìÑ Copiar T√≠tulo</button>
                                <button class="dropdown-item" onclick="copyContent(${video.rowIndex}, 'description')">üìù Copiar Desc.</button>
                            </div>
                        </div>
                    </div>
                `;
                    createdList.appendChild(item);
                });
            }

            document.getElementById('loader').style.display = 'none';
            document.getElementById('app').style.display = 'grid';
        }

        function deleteVideo(rowIndex) {
            if (confirm('¬øEst√°s seguro de eliminar este video permanentemente?')) {
                showLoader();
                google.script.run
                    .withSuccessHandler(() => {
                        showToast('Video eliminado correctamente', 'success');
                        loadVideos();
                    })
                    .withFailureHandler(handleError)
                    .deleteVideo(rowIndex);
            }
        }

        function updateStatus(rowIndex, status) {
            showLoader();
            google.script.run
                .withSuccessHandler(() => {
                    showToast(`Video marcado como ${status}`, 'success');
                    loadVideos();
                })
                .withFailureHandler(handleError)
                .updateVideoStatus(rowIndex, status);
        }

        function playVideo(url) {
            const playerWrapper = document.getElementById('player-wrapper');

            if (!url) {
                showToast('No hay URL de video disponible', 'error');
                return;
            }

            // Limpiar contenido previo
            playerWrapper.innerHTML = '';

            // Detectar si es un archivo de video directo (MP4, WebM, etc.) o del dominio mencionado
            const isDirectFile = url.match(/\.(mp4|webm|ogg)$/i) || url.includes('tempfile.aiquickdraw.com');

            if (isDirectFile) {
                // Usar etiqueta <video> nativa de HTML5
                const video = document.createElement('video');
                video.controls = true;
                video.autoplay = true;
                video.style.width = '100%';
                video.style.height = '100%';
                // A√±adir atributo playsinline para mejor soporte en m√≥viles (evita pantalla completa forzada a veces)
                video.setAttribute('playsinline', '');

                const source = document.createElement('source');
                source.src = url;
                source.type = 'video/mp4'; // Asumimos MP4 por defecto dado el ejemplo

                video.appendChild(source);
                playerWrapper.appendChild(video);

                // Manejar errores de carga del video
                video.onerror = function () {
                    console.error('Error cargando video nativo, intentando fallback iframe');
                    playerWrapper.innerHTML = `<iframe src="${url}" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
                };
            }
            else {
                // L√≥gica para otros proveedores (Drive, YouTube, etc.)
                let embedUrl = url;

                if (url.includes('drive.google.com')) {
                    embedUrl = url.replace('/view', '/preview').replace('/usp=sharing', '');
                }
                else if (url.includes('youtube.com') || url.includes('youtu.be')) {
                    if (url.includes('watch?v=')) {
                        embedUrl = url.replace('watch?v=', 'embed/');
                    } else if (url.includes('youtu.be/')) {
                        embedUrl = url.replace('youtu.be/', 'www.youtube.com/embed/');
                    }
                }

                playerWrapper.innerHTML = `<iframe src="${embedUrl}" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
            }

            // Scroll to player on mobile
            if (window.innerWidth < 900) {
                playerWrapper.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function toggleDropdown(event, rowIndex) {
            event.stopPropagation();
            const currentItem = event.currentTarget.closest('.video-item');
            // Cerrar otros men√∫s y limpiar estado
            const dropdowns = document.getElementsByClassName("dropdown-menu");
            for (let i = 0; i < dropdowns.length; i++) {
                if (dropdowns[i].id !== `dropdown-${rowIndex}`) {
                    dropdowns[i].classList.remove('show');
                }
            }
            const openItems = document.getElementsByClassName('video-item dropdown-open');
            while (openItems.length) {
                openItems[0].classList.remove('dropdown-open');
            }

            const dropdown = document.getElementById(`dropdown-${rowIndex}`);
            if (!dropdown) return;

            // Alternar si ya est√° visible
            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
                currentItem && currentItem.classList.remove('dropdown-open');
                return;
            }

            // Posicionar como overlay fijo respecto al viewport
            const rect = event.currentTarget.getBoundingClientRect();
            dropdown.classList.add('show');
            const menuWidth = dropdown.offsetWidth || 160;
            const menuHeight = dropdown.offsetHeight || 80;

            let left = rect.right - menuWidth;
            let top = rect.bottom + 6;

            if (left < 8) left = 8;
            const maxTop = window.innerHeight - menuHeight - 8;
            if (top > maxTop) top = rect.top - menuHeight - 6;

            dropdown.style.left = left + 'px';
            dropdown.style.top = top + 'px';
            dropdown.style.position = 'fixed';
            dropdown.style.zIndex = '3000';

            currentItem && currentItem.classList.add('dropdown-open');
        }

        function copyContent(rowIndex, type) {
            const video = allVideos.find(v => v.rowIndex === rowIndex);
            if (!video) return;

            let text = '';
            let message = '';

            if (type === 'title') {
                text = video.idea;
                message = 'T√≠tulo copiado';
            } else if (type === 'description') {
                text = video.descripcion || '';
                message = 'Descripci√≥n copiada';
            }

            if (!text) {
                showToast('No hay contenido para copiar', 'error');
                return;
            }

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => showToast(message, 'success'))
                    .catch(err => {
                        console.error('Error al copiar: ', err);
                        fallbackCopyTextToClipboard(text, message);
                    });
            } else {
                fallbackCopyTextToClipboard(text, message);
            }

            const dropdown = document.getElementById(`dropdown-${rowIndex}`);
            if (dropdown) dropdown.classList.remove('show');
        }

        function fallbackCopyTextToClipboard(text, successMessage = 'Copiado al portapapeles') {
            const textArea = document.createElement("textarea");
            textArea.value = text;

            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast(successMessage, 'success');
                } else {
                    showToast('No se pudo copiar el texto', 'error');
                }
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
                showToast('Error al copiar', 'error');
            }

            document.body.removeChild(textArea);
        }

        function handleError(error) {
            console.error(error);
            showToast('Error: ' + error.message, 'error');
            document.getElementById('loader').style.display = 'none';
        }

        function showLoader() {
            document.getElementById('loader').style.display = 'flex';
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;

            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }

        // Initial load
        loadVideos();
    </script>
</body>

</html>